<!-- --- START OF FILE ai_studio_code - 2025-12-28T214500.000.html --- -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Music@8481</title>
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f1014">
    <meta name="application-name" content="Music@8481">
    <meta name="description" content="Offline Music Player">

    <!-- ICONS -->
    <link rel="apple-touch-icon" href="https://ayush8481-dev.github.io/Temp/IMG_20251216_201906.jpg">
    <link rel="icon" type="image/jpeg" href="https://ayush8481-dev.github.io/Temp/IMG_20251216_201906.jpg">

    <!-- MANIFEST -->
    <link rel="manifest" id="my-manifest">

    <!-- Styles & Libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

    <style>
        :root { 
            --bg-dark: #0f1014; 
            --bg-card: #1e222b; 
            --primary: #ffffff; 
            --secondary: #aeb6c4; 
            --accent: #1ed760; /* Spotify Green */
            --dot-blue: #00ccff; /* Electric Blue for Dot */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* HOME BACKGROUND */
        @keyframes subtleDarkBreath { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        
        html, body { 
            height: 100%; width: 100%; 
            background: linear-gradient(-45deg, #000000, #002216, #0d1221, #1a0f0f);
            background-size: 400% 400%;
            animation: subtleDarkBreath 12s ease infinite;
            color: var(--primary); 
            overflow: hidden; display: flex; flex-direction: column; 
            user-select: none; -webkit-user-select: none; overscroll-behavior: none;
        }
        
        .view-container { flex: 1; overflow-y: auto; position: relative; padding-bottom: 90px; scroll-behavior: smooth; overscroll-behavior: contain; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* HEADER */
        .home-header { padding: 20px; padding-top: 30px; display: flex; justify-content: space-between; align-items: center; }
        .profile-section { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 5px; border-radius: 10px; transition: 0.2s; }
        .profile-section:active { background: rgba(255,255,255,0.1); }
        .profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); background: #333; pointer-events: none; }
        .header-text { display: flex; flex-direction: column; justify-content: center; pointer-events: none; }
        .app-brand { font-size: 18px; font-weight: 800; color: white; line-height: 1.1; }
        .user-greeting { font-size: 13px; color: var(--accent); font-weight: 600; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { background: rgba(255,255,255,0.2); }
        
        /* DJ BTN COLORS */
        .dj-btn { transition: all 0.3s ease; }
        .dj-btn.mode-bass { color: #ff4500 !important; box-shadow: 0 0 15px #ff4500; background: rgba(255, 69, 0, 0.2); animation: pulseRed 1s infinite; }
        .dj-btn.mode-enhanced { color: #00f2ff !important; box-shadow: 0 0 15px #00f2ff; background: rgba(0, 242, 255, 0.2); animation: pulseCyan 1s infinite; }
        .dj-btn.mode-8d { color: #d500f9 !important; box-shadow: 0 0 15px #d500f9; background: rgba(213, 0, 249, 0.2); animation: pulsePurple 1s infinite; }
        
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 69, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); } }
        @keyframes pulseCyan { 0% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 242, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); } }
        @keyframes pulsePurple { 0% { box-shadow: 0 0 0 0 rgba(213, 0, 249, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(213, 0, 249, 0); } 100% { box-shadow: 0 0 0 0 rgba(213, 0, 249, 0); } }

        /* GRID */
        .playlist-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .playlist-card { background: var(--bg-card); padding: 10px; border-radius: 8px; cursor: pointer; transition: transform 0.1s; }
        .playlist-card:active { transform: scale(0.98); }
        .pc-img { width: 100%; aspect-ratio: 1/1; border-radius: 6px; object-fit: cover; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s ease; }
        .pc-img.loaded { opacity: 1; }
        .pc-title { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pc-desc { font-size: 11px; color: var(--secondary); margin-top: 2px; }

        /* MARQUEE */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%); -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%); display: block; width: 100%; }
        .marquee-text { display: inline-block; vertical-align: middle; padding-right: 20px; }
        .marquee-text.scroll { padding-left: 100%; animation: scrollText 12s linear infinite; }
        @keyframes scrollText { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* PLAYLIST VIEW */
        .playlist-header-lg { position: relative; height: 280px; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; background-size: cover; background-position: center; }
        .header-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.1), var(--bg-dark)); }
        .ph-content { position: relative; z-index: 2; width: 100%; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(0,0,0,0.5); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .ph-title { font-size: 28px; font-weight: 800; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); line-height: 1.1; }
        .song-list { padding: 10px 0; }
        .song-row { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; overflow: hidden; }
        .song-row:active { background: rgba(255,255,255,0.05); }
        .sr-img { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; margin-right: 15px; background: #333; flex-shrink: 0; opacity: 0; transition: opacity 0.2s; }
        .sr-img.loaded { opacity: 1; }
        .sr-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; margin-right: 10px; overflow: hidden; }
        .sr-title { font-size: 15px; font-weight: 600; color: white; white-space: nowrap; display: inline-block; }
        .sr-artist { font-size: 12px; color: var(--secondary); }
        .song-row.playing .sr-title { color: var(--accent) !important; }

        /* MINI PLAYER */
        @keyframes premiumFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .mini-player { 
            position: fixed; bottom: 15px; left: 15px; width: calc(100% - 30px); height: 65px; 
            background: linear-gradient(135deg, #1c1c1c, #1a237e, #004d40, #880e4f, #000000); 
            background-size: 300% 300%; animation: premiumFlow 12s ease infinite;
            border-radius: 12px; display: flex; align-items: center; padding: 0 12px; z-index: 3000; 
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateY(150%); 
            will-change: transform; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05);
        }
        .mini-player.show { transform: translateY(0); }
        
        .mp-progress-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.1); }
        .mp-progress-fill { height: 100%; background: var(--accent); width: 0%; border-radius: 2px; transition: width 0.1s linear; }
        .mp-img { width: 45px; height: 45px; border-radius: 6px; margin-right: 12px; object-fit: cover; background: #333; position: relative; z-index: 2; flex-shrink: 0; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .mp-img.spin-anim { border-radius: 50%; animation: spinVinyl 4s linear infinite; } 
        @keyframes spinVinyl { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mp-info { flex: 1; overflow: hidden; padding-right: 5px; min-width: 0; z-index: 2; display: flex; flex-direction: column; justify-content: center; }
        .mp-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 2px; }
        .mp-artist-mini { font-size: 11px; color: rgba(255,255,255,0.7); }
        .mp-controls { display: flex; align-items: center; gap: 5px; z-index: 2; }
        .mp-ctrl { background: none; border: none; color: white; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: color 0.2s; }
        .mp-ctrl:active { color: var(--accent); }
        .mp-play-btn { color: white; font-size: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; margin: 0 5px; }
        .mp-heart { font-size: 18px; color: rgba(255,255,255,0.5); width: 35px; height: 35px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .mp-heart.liked { color: #e91429; }

        /* FULL PLAYER */
        .full-player { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #1c1c1c, #1a237e, #004d40, #880e4f, #000000); 
            background-size: 300% 300%; animation: premiumFlow 12s ease infinite; 
            z-index: 2000; padding: 25px; display: flex; flex-direction: column; justify-content: space-evenly; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
        }
        .full-player.active { transform: translateY(0); }
        .fp-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .fp-img-container { width: 100%; height: 45vh; max-height: 400px; margin: 10px 0; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; overflow: visible; }
        .fp-img { position: absolute; width: auto; height: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 12px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); will-change: transform, opacity; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s ease; }
        .fp-img.active { transform: translateX(0) scale(1) rotate(0deg); opacity: 1; z-index: 2; }
        .fp-img.enter-right { transform: translateX(100%) scale(0.8) rotate(10deg); opacity: 0; z-index: 1; }
        .fp-img.enter-left { transform: translateX(-100%) scale(0.8) rotate(-10deg); opacity: 0; z-index: 1; }
        .fp-img.exit-left { transform: translateX(-120%) rotate(-20deg); opacity: 0; z-index: 2; }
        .fp-img.exit-right { transform: translateX(120%) rotate(20deg); opacity: 0; z-index: 2; }
        .fp-img.dragging { transition: none !important; }
        .fp-info { margin-bottom: 20px; overflow: hidden; width: 100%; flex-shrink: 0; }
        .fp-title { font-size: 24px; font-weight: 800; margin-bottom: 5px; line-height: 1.2; display: inline-block; }
        .fp-artist { color: var(--secondary); font-size: 16px; }
        
        /* --- SMALLER SLIDER CONTAINER --- */
        .slider-container { width: 90%; margin: 0 auto 15px auto; position: relative; flex-shrink: 0; }
        
        /* --- WATER FLOW SLIDER ANIMATION --- */
        @keyframes waterFlow {
            0% { background-position: -200% 0, 0 0; }
            100% { background-position: 200% 0, 0 0; } 
        }

        /* --- SLIMMER SLIDER TRACK --- */
        input[type=range] { 
            -webkit-appearance: none; width: 100%; height: 4px; /* Slimmer track */
            background-color: rgba(255, 255, 255, 0.1); border-radius: 2px; outline: none; 
            
            background-image: 
                linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.6) 50%, transparent 100%), 
                linear-gradient(90deg, var(--accent), var(--accent));
                
            background-size: 50% 100%, 0% 100%; 
            background-repeat: no-repeat;
            background-position: -200% 0, 0 0; 
        }
        
        input[type=range].animating {
            animation: waterFlow 3s linear infinite;
        }

        /* --- SMALLER SLIDER THUMB --- */
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 15px; width: 15px; 
            border-radius: 50%; background: var(--dot-blue); cursor: pointer; 
            box-shadow: 0 0 15px var(--dot-blue), 0 0 3px #ffffff;
            transition: transform 0.1s; border: 2px solid white;
            position: relative; z-index: 10;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.3); }

        .time-wrap { display: flex; justify-content: space-between; font-size: 12px; color: var(--secondary); margin-top: 8px; }
        .fp-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .btn-ctrl { background: none; border: none; color: white; font-size: 24px; cursor: pointer; transition: color 0.2s; }
        .btn-ctrl.active-ctrl { color: var(--accent); } 
        .btn-play-lg { width: 70px; height: 70px; background: white; color: black; border-radius: 50%; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 20px rgba(255, 255, 255, 0.3); }
        .fp-actions { display: flex; gap: 25px; margin-top: 10px; align-items: center; }
        .heart-icon.liked { color: #e91429; } 

        /* SETUP & INSTALL */
        .setup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f1014; z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .setup-card { width: 100%; max-width: 350px; text-align: center; }
        .setup-title { font-size: 24px; font-weight: 800; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .styled-input { width: 100%; padding: 15px; background: #1e222b; border: 1px solid #333; color: white; border-radius: 10px; font-size: 16px; outline: none; }
        .file-upload-btn { display: inline-block; padding: 10px 20px; background: #333; color: white; border-radius: 20px; cursor: pointer; font-size: 14px; margin-top: 10px; }
        .start-btn { width: 100%; padding: 15px; background: var(--accent); color: black; border: none; border-radius: 30px; font-weight: 800; font-size: 16px; cursor: pointer; margin-top: 10px; }
        
        /* CREDIT */
        .app-credit { 
            text-align: center; padding: 30px; color: #444; font-size: 11px; font-weight: 600; 
            text-transform: none !important; letter-spacing: 1px; 
        }

        /* MODALS & POPUPS */
        .crop-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .crop-box { width: 90%; max-width: 350px; background: #202020; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .crop-container { width: 100%; height: 320px; background: #000; position: relative; }
        .crop-controls { padding: 15px; display: flex; justify-content: space-around; background: #202020; border-top: 1px solid #333; }
        .crop-btn { padding: 8px 25px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-cancel { background: #333; color: white; }
        .btn-save { background: var(--accent); color: black; }

        .options-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: flex-end; }
        .options-menu { width: 100%; background: #202020; border-top-left-radius: 15px; border-top-right-radius: 15px; padding: 20px; animation: slideUp 0.3s; }
        .option-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #333; font-size: 16px; cursor: pointer; }
        .option-item i { margin-right: 15px; width: 25px; text-align: center; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 2500; display: none; flex-direction: column; padding: 20px; animation: fadeIn 0.2s; }
        .search-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .search-input-box { flex: 1; position: relative; }
        .search-input { width: 100%; background: #202020; border: none; padding: 12px 15px; padding-left: 40px; border-radius: 25px; color: white; font-size: 16px; outline: none; }
        .search-icon-in { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888; font-size: 14px; }
        .search-close { background: none; border: none; color: white; font-size: 16px; cursor: pointer; }
        .search-results { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .no-results { text-align: center; color: #666; margin-top: 50px; font-size: 14px; }

        .loader { text-align: center; margin-top: 50px; color: var(--secondary); display: none; }
        
        /* DYNAMIC TOAST COLORS */
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); color: black; padding: 10px 20px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 4000; display: none; animation: fadeUp 0.3s; transition: background 0.3s; }
        @keyframes fadeUp { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* STING ENERGY ANIMATION TEXT */
        .sting-text {
            font-family: 'Inter', sans-serif; font-style: italic; font-weight: 900;
            display: inline-block; letter-spacing: 1px; animation: stingLightning 2s infinite linear;
        }
        @keyframes stingLightning {
            0% { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
            25% { color: #ffd700; text-shadow: 0 0 15px #ff4500; }
            50% { color: #00f2ff; text-shadow: 0 0 20px #00f2ff; }
            75% { color: #ffffff; text-shadow: 0 0 25px #00aaff; }
            100% { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body oncontextmenu="return false;">

    <!-- SETUP / PROFILE SCREEN -->
    <div id="setup-screen" class="setup-overlay" style="display: none;">
        <div class="setup-card">
            <h1 class="setup-title">Music@8481</h1>
            <div style="margin-bottom: 20px;">
                <img id="preview-img" src="https://www.pngfind.com/pngs/m/610-6104451_image-placeholder-png-user-profile-placeholder-image-png.png" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">
                <br>
                <label for="profile-upload" class="file-upload-btn">
                    <i class="fas fa-camera"></i> Change Photo
                </label>
                <input type="file" id="profile-upload" accept="image/*" style="display: none;" onchange="openCropper(event)">
            </div>
            <div class="input-group">
                <label>Display Name</label>
                <input type="text" id="user-name-input" class="styled-input" placeholder="e.g. Ayush">
            </div>
            <button class="start-btn" id="setup-btn" onclick="saveProfile()">Save Profile</button>
            <p style="margin-top: 15px; font-size: 12px; color: #666; cursor: pointer;" onclick="skipProfile()">Close</p>
        </div>
    </div>

    <!-- CROPPER -->
    <div id="crop-modal" class="crop-modal">
        <div class="crop-box">
            <div class="crop-container">
                <img id="crop-image" style="max-width: 100%; display: block;">
            </div>
            <div class="crop-controls">
                <button class="crop-btn btn-cancel" onclick="cancelCrop()">Cancel</button>
                <button class="crop-btn btn-save" onclick="saveCrop()">Crop & Save</button>
            </div>
        </div>
    </div>

    <!-- SEARCH OVERLAY -->
    <div id="search-view" class="search-overlay">
        <div class="search-header">
            <div class="search-input-box">
                <i class="fas fa-search search-icon-in"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Search Songs" oninput="performSearch(this.value)">
            </div>
            <button class="search-close" onclick="toggleSearch(false)">Cancel</button>
        </div>
        <div id="search-results-list" class="search-results"></div>
    </div>

    <!-- MAIN APP VIEW -->
    <div class="view-container">
        <div id="toast" class="toast">Action Completed</div>
        <div id="loader" class="loader"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top:10px;">Loading...</p></div>

        <!-- HOME -->
        <div id="view-home" class="screen active">
            <div class="home-header">
                <div class="profile-section" id="profile-trigger">
                    <img id="header-profile-img" src="https://www.pngfind.com/pngs/m/610-6104451_image-placeholder-png-user-profile-placeholder-image-png.png" class="profile-pic">
                    <div class="header-text">
                        <div class="app-brand">Music@8481</div>
                        <div class="user-greeting" id="display-name">Guest User</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleSearch(true)"><i class="fas fa-search"></i></button>
                    <!-- UPDATED DJ BUTTON -->
                    <button class="icon-btn dj-btn" id="dj-btn" onclick="cycleEqMode()"><i class="fas fa-compact-disc"></i></button>
                    <button class="icon-btn refresh-btn" onclick="manualSync()"><i class="fas fa-sync"></i></button>
                </div>
            </div>
            <div class="playlist-grid" id="library-grid"></div>
            <div class="app-credit">Developed By <span class="sting-text">Ayush@8481</span></div>
        </div>

        <!-- PLAYLIST -->
        <div id="view-playlist" class="screen">
            <div class="playlist-header-lg" id="ph-bg">
                <div class="header-overlay"></div>
                <button class="back-btn" onclick="handleBackAction()"><i class="fas fa-arrow-left"></i></button>
                <div class="ph-content">
                    <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 5px;">PLAYLIST</div>
                    <div class="marquee-container" style="width: 100%;">
                        <div class="ph-title marquee-text" id="ph-title">Playlist Name</div>
                    </div>
                    <div style="font-size: 13px; color: #ccc;" id="ph-count">0 Songs</div>
                </div>
            </div>
            <div class="song-list" id="playlist-songs"></div>
        </div>
    </div>

    <!-- SPOTIFY STYLE MINI PLAYER -->
    <div class="mini-player" id="mini-player" onclick="openFullPlayer()">
        <div class="mp-progress-bg"><div class="mp-progress-fill" id="mp-progress"></div></div>
        <img src="" class="mp-img" id="mp-img">
        <div class="mp-info">
            <div class="marquee-container" style="width: 100%;">
                <div class="mp-title marquee-text" id="mp-title">Song Title</div>
            </div>
            <div class="mp-artist-mini">Ayush@8481</div>
        </div>
        <div class="mp-controls">
            <i class="far fa-heart mp-heart" id="mp-heart" onclick="event.stopPropagation(); toggleLike()"></i>
            <button class="mp-ctrl" onclick="event.stopPropagation(); prevSong(false)"><i class="fas fa-step-backward"></i></button>
            <button class="mp-ctrl mp-play-btn" onclick="event.stopPropagation(); togglePlay()">
                <i class="fas fa-play" id="mp-play-icon"></i>
            </button>
            <button class="mp-ctrl" onclick="event.stopPropagation(); nextSong(false)"><i class="fas fa-step-forward"></i></button>
        </div>
    </div>

    <!-- FULL PLAYER -->
    <div class="full-player" id="full-player">
        <div class="fp-top">
            <button class="btn-ctrl" onclick="handleBackAction()"><i class="fas fa-chevron-down"></i></button>
            <div style="font-size: 12px; letter-spacing: 1px; color: #ccc;">NOW PLAYING</div>
            <button class="btn-ctrl" onclick="openOptionsMenu()"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        
        <div class="fp-img-container" id="fp-img-area"></div>

        <div class="fp-info">
            <div class="marquee-container">
                <div class="fp-title marquee-text" id="fp-title">Title</div>
            </div>
            <div class="fp-artist" style="margin-top:5px; color:#aeb6c4;">Ayush@8481</div>
            <div class="fp-actions">
                <i class="far fa-heart btn-ctrl heart-icon" id="fp-heart" onclick="toggleLike()"></i>
                <div id="offline-badge" style="display:none; color:var(--accent); font-size:12px; border:1px solid var(--accent); padding:2px 8px; border-radius:10px;">
                    <i class="fas fa-check-circle"></i> Downloaded
                </div>
            </div>
        </div>
        <div class="slider-container">
            <input type="range" id="seek-slider" min="0" value="0">
            <div class="time-wrap"><span id="curr-time">0:00</span><span id="dur-time">0:00</span></div>
        </div>
        <div class="fp-controls">
            <button class="btn-ctrl" id="btn-shuffle" onclick="toggleShuffle()"><i class="fas fa-random"></i></button>
            <button class="btn-ctrl" onclick="prevSong(true)"><i class="fas fa-step-backward"></i></button>
            <button class="btn-play-lg" onclick="togglePlay()"><i class="fas fa-play" id="fp-play-icon"></i></button>
            <button class="btn-ctrl" onclick="nextSong(true)"><i class="fas fa-step-forward"></i></button>
            <button class="btn-ctrl" id="btn-loop" onclick="toggleLoop()"><i class="fas fa-retweet"></i></button>
        </div>
    </div>

    <!-- OPTIONS -->
    <div class="options-overlay" id="options-menu" onclick="closeOptionsMenu(event)">
        <div class="options-menu">
            <div id="download-option" class="option-item" onclick="downloadCurrentSong()"><i class="fas fa-download"></i> Download</div>
            <div id="delete-option" class="option-item" onclick="deleteCurrentDownload()" style="display: none; color: #e91429;"><i class="fas fa-trash"></i> Delete from Device</div>
            <div class="option-item" onclick="document.getElementById('options-menu').style.display='none'"><i class="fas fa-times"></i> Close</div>
        </div>
    </div>

    <script>
        const APP_NAME = "Music@8481";
        const APP_ICON = "https://ayush8481-dev.github.io/Temp/IMG_20251216_201906.jpg";
        const DEFAULT_IMG = "https://www.pngfind.com/pngs/m/610-6104451_image-placeholder-png-user-profile-placeholder-image-png.png";
        
        const manifestContent = {
            "name": APP_NAME,
            "short_name": APP_NAME,
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0f1014",
            "theme_color": "#0f1014",
            "icons": [{ "src": APP_ICON, "sizes": "512x512", "type": "image/jpeg" }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestContent)], {type: 'application/json'});
        document.getElementById('my-manifest').href = URL.createObjectURL(manifestBlob);

        const ASSETS = [
            DEFAULT_IMG,
            APP_ICON,
            "https://ayush8481-dev.github.io/Temp/IMG_20251215_203700.jpg", 
            "https://ayush8481-dev.github.io/Temp/IMG_20251215_181901.jpg", 
            "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css",
            "https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap",
            "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css",
            "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"
        ];

        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'm8481-v30';
                const ASSETS = ${JSON.stringify(ASSETS)};
                self.addEventListener('install', (e) => { e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS))); });
                self.addEventListener('activate', (e) => { e.waitUntil(self.clients.claim()); });
                self.addEventListener('fetch', (e) => {
                    if (e.request.method !== 'GET') return;
                    e.respondWith(caches.match(e.request).then(cached => cached || fetch(e.request)));
                });
            `;
            const blob = new Blob([swContent], {type: 'text/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(console.error);
        }

        async function cacheEssentialAssets() {
            if('caches' in window) { try { const cache = await caches.open('m8481-v30'); await cache.addAll(ASSETS); } catch(e) {} }
        }

        let db;
        const DB_NAME = "MusicAppDB_8481";
        const STORE_NAME = "songs";

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    if (!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        async function saveBlob(url, blob) {
            if(!db) await initDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put(blob, url);
        }

        async function deleteBlob(url) {
            if(!db) await initDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).delete(url);
        }

        async function getBlob(url) {
            if(!db) await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, "readonly");
                const req = tx.objectStore(STORE_NAME).get(url);
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = () => resolve(null);
            });
        }
        
        let cacheMeta = JSON.parse(localStorage.getItem('m8_cache_meta')) || {};

        function updateCacheMeta(url) {
            cacheMeta[url] = Date.now();
            localStorage.setItem('m8_cache_meta', JSON.stringify(cacheMeta));
        }

        async function cleanUpOldCache() {
            if(!db) await initDB();
            const now = Date.now();
            const TWO_DAYS = 48 * 60 * 60 * 1000;
            const urlsToDelete = [];
            for (const [url, timestamp] of Object.entries(cacheMeta)) {
                const isExplicitDownload = downloadedSongs.some(d => d.url === url);
                if (isExplicitDownload) continue;
                if (now - timestamp > TWO_DAYS) { urlsToDelete.push(url); }
            }
            for (const url of urlsToDelete) {
                await deleteBlob(url);
                delete cacheMeta[url];
            }
            localStorage.setItem('m8_cache_meta', JSON.stringify(cacheMeta));
        }

        let onlinePlaylists = [];
        let allPlaylists = [];
        let displayPlaylists = [];
        let likedSongs = JSON.parse(localStorage.getItem('my_liked_songs')) || [];
        let downloadedSongs = JSON.parse(localStorage.getItem('my_downloaded_songs')) || [];
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || null;
        let viewingPlaylistIndex = -1;
        
        let player = { queue: [], songIndex: 0, originalUrl: "", isPlaying: false };
        let playSessionId = 0; 
        let cacheTimer = null; 
        let isNextPreloaded = false; // Flag for smart preloading

        let isShuffle = false;
        let isLoop = false;
        
        // --- EQ + 8D SYSTEM ---
        let eqMode = parseInt(localStorage.getItem('m8_eq_mode')) || 0; 
        // 0: Normal, 1: Deep Bass, 2: Enhanced, 3: 8D Audio
        
        // Tuned for better separation
        const djFrequencies = [31, 62, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
        
        // REFINED PRESETS TO PREVENT CLIPPING
        const eqPresets = [
            [0,0,0,0,0,0,0,0,0,0], // Normal (Flat)
            [6, 5, 2, -2, -2, 0, 1, 2, 3, 3], // Deep Bass (Clean Sub, cut mud, clear highs)
            [4, 3, 0, -1, -2, 0, 3, 5, 5, 5], // Enhanced (V-Shape: Crisp)
            [3, 3, 1, 0, 0, 0, 0, 1, 2, 2] // 8D Base
        ];
        
        let audioCtx;
        let audioSource;
        let eqBands = [];
        let compressorNode;
        let preGainNode;
        
        // 8D Specific Nodes
        let pannerNode; 
        let filterNode; 
        let gainNode8D; 
        let pannerInterval;
        let delayNode;

        let cropper = null;
        const cropModal = document.getElementById('crop-modal');
        const cropImageEl = document.getElementById('crop-image');
        
        const audio = new Audio();
        audio.crossOrigin = "anonymous"; 
        audio.preload = "auto"; 
        
        const viewHome = document.getElementById('view-home');
        const viewPlaylist = document.getElementById('view-playlist');
        const loader = document.getElementById('loader');
        const libraryGrid = document.getElementById('library-grid');
        const seekSlider = document.getElementById('seek-slider');
        const fullPlayer = document.getElementById('full-player');
        
        let homeBackPressCounter = 0;

        function initHistoryTrap() {
            window.history.pushState({page: 'home'}, document.title, window.location.href);
            window.addEventListener('popstate', (event) => {
                if(document.getElementById('search-view').style.display === 'flex') {
                   toggleSearch(false);
                   window.history.pushState({page: 'home'}, document.title, window.location.href);
                   return;
                }
                if(fullPlayer.classList.contains('active')) {
                    fullPlayer.classList.remove('active');
                    if(player.queue.length > 0 && localStorage.getItem('m8_player_closed') !== 'true') {
                        document.getElementById('mini-player').style.display = 'flex';
                        setTimeout(() => document.getElementById('mini-player').classList.add('show'), 10);
                    }
                    window.history.pushState({page: 'home'}, document.title, window.location.href);
                    homeBackPressCounter = 0;
                    return;
                } 
                else if(viewPlaylist.classList.contains('active')) {
                    viewPlaylist.classList.remove('active');
                    viewHome.classList.add('active');
                    renderHome();
                    window.history.pushState({page: 'home'}, document.title, window.location.href);
                    homeBackPressCounter = 0;
                    return;
                }
                homeBackPressCounter++;
                if (homeBackPressCounter < 5) {
                    window.history.pushState({page: 'home'}, document.title, window.location.href);
                    showToast(`Press Back ${5 - homeBackPressCounter} more times to exit`);
                }
            });
        }

        async function restoreLastSession() {
            if(localStorage.getItem('m8_player_closed') === 'true') return;
            const savedSession = JSON.parse(localStorage.getItem('m8_last_session'));
            if(savedSession && savedSession.queue && savedSession.queue.length > 0) {
                player.queue = savedSession.queue;
                player.songIndex = savedSession.songIndex || 0;
                player.isPlaying = false;
                document.getElementById('mini-player').classList.add('show');
                const song = player.queue[player.songIndex];
                if(song) {
                    const offlineBlob = await getBlob(song.url);
                    if(offlineBlob) {
                        const url = URL.createObjectURL(offlineBlob);
                        audio.src = url;
                        player.originalUrl = song.url;
                    } else {
                        player.originalUrl = song.url;
                        audio.src = song.url; 
                    }

                    audio.addEventListener('loadedmetadata', () => {
                         audio.currentTime = savedSession.currentTime || 0;
                    }, { once: true });

                    const miniImg = document.getElementById('mp-img');
                    miniImg.src = song.image;
                    miniImg.classList.remove('spin-anim');
                    checkMarquee(document.getElementById('mp-title'), song.title);
                    checkMarquee(document.getElementById('fp-title'), song.title);
                    document.getElementById('mp-play-icon').className = `fas fa-play`;
                    const isLiked = likedSongs.some(s => s.url === song.url);
                    const mpHeart = document.getElementById('mp-heart');
                    if(isLiked) { mpHeart.classList.remove('far'); mpHeart.classList.add('fas', 'liked'); }
                    else { mpHeart.classList.add('far'); mpHeart.classList.remove('fas', 'liked'); }
                    const imgContainer = document.getElementById('fp-img-area');
                    imgContainer.innerHTML = ''; 
                    const img = document.createElement('img');
                    img.src = song.image;
                    img.className = 'fp-img active';
                    imgContainer.appendChild(img);
                }
            }
        }

        function saveSession() {
            const session = { queue: player.queue, songIndex: player.songIndex, currentTime: audio.currentTime };
            localStorage.setItem('m8_last_session', JSON.stringify(session));
        }
        
        let mpStartX = 0;
        const mpEl = document.getElementById('mini-player');
        mpEl.addEventListener('touchstart', e => { mpStartX = e.touches[0].clientX; }, {passive: true});
        mpEl.addEventListener('touchmove', e => {
            const diff = e.touches[0].clientX - mpStartX;
            if(diff > 0) { mpEl.style.transform = `translate(${diff}px, 0)`; }
        }, {passive: true});
        mpEl.addEventListener('touchend', e => {
            const diff = e.changedTouches[0].clientX - mpStartX;
            const threshold = window.innerWidth * 0.60;
            if(diff > threshold) { 
                 localStorage.setItem('m8_player_closed', 'true');
                 mpEl.style.transition = 'transform 0.3s ease';
                 mpEl.style.transform = 'translateX(100%)'; 
                 setTimeout(() => {
                     audio.pause();
                     mpEl.classList.remove('show');
                     mpEl.style.display = 'none'; 
                     mpEl.style.transform = ''; 
                     mpEl.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)'; 
                     player.isPlaying = false;
                 }, 300);
            } else { mpEl.style.transform = ''; }
        });

        async function verifyOfflineIntegrity() {
            if(!db) await initDB();
            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAllKeys();
            request.onsuccess = () => {
                const dbKeys = request.result; 
                const validDownloads = downloadedSongs.filter(song => dbKeys.includes(song.url));
                if(validDownloads.length !== downloadedSongs.length) {
                    downloadedSongs = validDownloads;
                    localStorage.setItem('my_downloaded_songs', JSON.stringify(downloadedSongs));
                }
                renderHome(); 
            };
        }

        (async function autoInit() {
            await initDB();
            cacheEssentialAssets();
            verifyOfflineIntegrity(); 
            cleanUpOldCache(); 
            initHistoryTrap(); 
            if(userProfile) loadProfileUI();
            else { document.getElementById('preview-img').src = DEFAULT_IMG; document.getElementById('setup-screen').style.display = 'flex'; }
            
            if(eqMode > 0) applyEqMode(); 

            mergePlaylists();
            renderHome(); 
            fetchData();
            restoreLastSession(); 
            
            window.addEventListener('online', () => { 
                showToast("Now Online ðŸŸ¢", "success");
                setTimeout(() => fetchData(), 2000); 
                
                if (player.isPlaying && (audio.paused || audio.error || audio.networkState === audio.NETWORK_NO_SOURCE)) {
                    const curTime = audio.currentTime;
                    audio.src = player.originalUrl;
                    audio.load();
                    audio.currentTime = curTime;
                    audio.play().catch(e => console.log("Auto-resume failed", e));
                }
            });

            window.addEventListener('offline', () => { 
                showToast("You are Offline ðŸ”´", "error"); 
                renderHome(); 
            });
            
            window.addEventListener('beforeunload', saveSession); 
        })();

        function handleBackAction() { window.history.back(); }

        async function manualSync() {
             showToast("Refreshing...");
             onlinePlaylists = [];
             await fetchData();
             showToast("Refreshed!", "success");
        }

        function toggleSearch(show) {
            const el = document.getElementById('search-view');
            el.style.display = show ? 'flex' : 'none';
            if(show) { document.getElementById('search-input').focus(); window.history.pushState({page: 'search'}, "Search", window.location.href); } 
            else { document.getElementById('search-input').value = ''; document.getElementById('search-results-list').innerHTML = ''; }
        }

        function getLevenshteinDistance(a, b) {
            const matrix = [];
            for(let i=0; i<=b.length; i++) matrix[i] = [i];
            for(let j=0; j<=a.length; j++) matrix[0][j] = j;
            for(let i=1; i<=b.length; i++){
                for(let j=1; j<=a.length; j++){
                    if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
                    else matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1)); 
                }
            }
            return matrix[b.length][a.length];
        }

        function performSearch(query) {
            const list = document.getElementById('search-results-list');
            list.innerHTML = '';
            query = query.toLowerCase().replace(/\./g, '').trim();
            if(!query || query.length < 2) return;
            const results = [];
            const allSongs = [];
            const seenUrls = new Set();
            onlinePlaylists.forEach(pl => { pl.songs.forEach(s => { if(!seenUrls.has(s.url)) { allSongs.push(s); seenUrls.add(s.url); } }); });
            downloadedSongs.forEach(s => { if(!seenUrls.has(s.url)) { allSongs.push(s); seenUrls.add(s.url); } });
            allSongs.forEach(song => {
                const title = song.title.toLowerCase().replace(/\./g, '');
                if(title.includes(query)) { results.push({ song, score: 0 }); } 
                else {
                    const dist = getLevenshteinDistance(title, query);
                    const allowedErrors = Math.floor(title.length / 2); 
                    if(dist <= 3 && dist <= allowedErrors) { results.push({ song, score: dist }); }
                }
            });
            results.sort((a,b) => a.score - b.score);
            if(results.length === 0) { list.innerHTML = '<div class="no-results">No matches found.</div>'; } 
            else {
                results.forEach(item => {
                    const s = item.song;
                    const row = document.createElement('div');
                    row.className = 'song-row';
                    row.onclick = () => {
                        let contextQueue = [s];
                        let contextIndex = 0;
                        let foundContext = false;
                        for(let pl of onlinePlaylists) {
                            const idx = pl.songs.findIndex(x => x.url === s.url);
                            if(idx !== -1) { contextQueue = pl.songs; contextIndex = idx; foundContext = true; break; }
                        }
                        if(!foundContext) {
                            const idx = downloadedSongs.findIndex(x => x.url === s.url);
                            if(idx !== -1) { contextQueue = downloadedSongs; contextIndex = idx; }
                        }
                        player.queue = contextQueue;
                        player.songIndex = contextIndex;
                        toggleSearch(false);
                        document.getElementById('fp-img-area').innerHTML = `<img src="${s.image}" class="fp-img active">`;
                        loadAndPlay();
                    };
                    row.innerHTML = `<img src="${s.image}" class="sr-img loaded"><div class="sr-info"><div class="sr-title">${s.title}</div><div class="sr-artist">Ayush@8481</div></div>`;
                    list.appendChild(row);
                });
            }
        }

        let startX, currentX, isDragging = false;
        const imgContainer = document.getElementById('fp-img-area');
        function getActiveImg() { return imgContainer.querySelector('.fp-img.active'); }
        imgContainer.addEventListener('touchstart', e => { const activeImg = getActiveImg(); if(!activeImg) return; startX = e.touches[0].clientX; isDragging = true; activeImg.classList.add('dragging'); }, {passive: false});
        imgContainer.addEventListener('touchmove', e => { if(!isDragging) return; const activeImg = getActiveImg(); if(!activeImg) return; e.preventDefault(); currentX = e.touches[0].clientX; const diff = currentX - startX; const rotate = diff / 20; activeImg.style.transform = `translateX(${diff}px) rotate(${rotate}deg)`; }, {passive: false});
        imgContainer.addEventListener('touchend', e => { if(!isDragging) return; isDragging = false; const activeImg = getActiveImg(); if(!activeImg) return; activeImg.classList.remove('dragging'); const diff = currentX - startX; if (diff < -80) { activeImg.style.transform = ''; nextSong(true); } else if (diff > 80) { activeImg.style.transform = ''; prevSong(true); } else { activeImg.style.transform = ''; } });

        function animateSlide(direction, newSong) {
            const oldImg = getActiveImg();
            if(!oldImg) { const img = document.createElement('img'); img.src = newSong.image; img.className = 'fp-img active'; imgContainer.appendChild(img); return; }
            const exitClass = direction === 'next' ? 'exit-left' : 'exit-right';
            const enterClass = direction === 'next' ? 'enter-right' : 'enter-left';
            oldImg.classList.remove('active'); oldImg.classList.add(exitClass);
            const newImg = document.createElement('img'); newImg.src = newSong.image; newImg.className = `fp-img ${enterClass}`; imgContainer.appendChild(newImg);
            void newImg.offsetWidth; newImg.classList.remove(enterClass); newImg.classList.add('active');
            setTimeout(() => { if(oldImg && oldImg.parentNode) oldImg.parentNode.removeChild(oldImg); }, 400);
        }

        async function loadImagesSequentially(images) {
            for (let img of images) {
                if (!img.dataset.src) continue;
                await new Promise((resolve) => { img.onload = () => { img.classList.add('loaded'); resolve(); }; img.onerror = resolve; img.src = img.dataset.src; });
            }
        }

        function initAudioContext() {
            if (audioCtx) return; 
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            audioSource = audioCtx.createMediaElementSource(audio);
            
            preGainNode = audioCtx.createGain();
            // LOWER GAIN TO CREATE HEADROOM (Fixes Crackling)
            preGainNode.gain.value = 0.5; 
            
            pannerNode = new StereoPannerNode(audioCtx, { pan: 0 });
            filterNode = audioCtx.createBiquadFilter();
            filterNode.type = 'lowpass';
            filterNode.frequency.value = 20000; 
            
            gainNode8D = audioCtx.createGain();
            gainNode8D.gain.value = 1.0;

            audioSource.connect(preGainNode);
            let prevNode = preGainNode;
            eqBands = [];
            
            djFrequencies.forEach((freq, index) => {
                const filter = audioCtx.createBiquadFilter();
                filter.frequency.value = freq;
                if (index <= 1) filter.type = 'lowshelf'; 
                else if (index === djFrequencies.length - 1) filter.type = 'highshelf';
                else { filter.type = 'peaking'; filter.Q.value = 1.2; } 
                
                filter.gain.value = eqPresets[eqMode][index];
                
                prevNode.connect(filter);
                prevNode = filter;
                eqBands.push(filter);
            });
            
            // Compressor Tuned as a Limiter to catch peaks
            compressorNode = audioCtx.createDynamicsCompressor();
            compressorNode.threshold.value = -3; // Only catch very loud peaks
            compressorNode.knee.value = 5; 
            compressorNode.ratio.value = 15; 
            compressorNode.attack.value = 0.005; 
            compressorNode.release.value = 0.1;
            
            prevNode.connect(gainNode8D);
            gainNode8D.connect(filterNode);
            filterNode.connect(pannerNode);
            pannerNode.connect(compressorNode);
            compressorNode.connect(audioCtx.destination);
            
            applyEqMode(); 
        }

        function cycleEqMode() {
            eqMode = (eqMode + 1) % 4;
            localStorage.setItem('m8_eq_mode', eqMode);
            applyEqMode();
        }

        function applyEqMode() {
            const btn = document.getElementById('dj-btn');
            const modes = ["Normal", "Deep Bass", "Enhanced", "8D Audio"];
            
            // Significant Pre-Gain reduction for Bass Mode to avoid clipping
            const preGains = [0.9, 0.4, 0.5, 0.6]; 

            btn.classList.remove('mode-bass', 'mode-enhanced', 'mode-8d');

            if (eqMode === 1) btn.classList.add('mode-bass');
            else if (eqMode === 2) btn.classList.add('mode-enhanced');
            else if (eqMode === 3) btn.classList.add('mode-8d');
            
            showToast(`Sound: ${modes[eqMode]}`);

            if (!audioCtx) initAudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const now = audioCtx.currentTime;
            
            eqBands.forEach((band, index) => {
                const targetGain = eqPresets[eqMode][index];
                if(band.gain.setTargetAtTime) band.gain.setTargetAtTime(targetGain, now, 0.1);
                else band.gain.value = targetGain;
            });

            const targetPreGain = preGains[eqMode];
            if(preGainNode.gain.setTargetAtTime) preGainNode.gain.setTargetAtTime(targetPreGain, now, 0.1);
            else preGainNode.gain.value = targetPreGain;

            if(pannerInterval) cancelAnimationFrame(pannerInterval);
            
            // --- SMOOTHED 8D ALGORITHM (No crackling) ---
            if(eqMode === 3) {
                const start8D = () => {
                    const t = Date.now() / 3000; 
                    const x = Math.sin(t);
                    
                    // Smooth pan transition
                    pannerNode.pan.value = x * 0.9; 

                    // Gentle Filter modulation
                    const freq = (Math.cos(t) < 0) ? 8000 : 18000;
                    filterNode.frequency.value = filterNode.frequency.value * 0.95 + freq * 0.05; 

                    const distGain = 0.9 + (0.1 * Math.abs(Math.cos(t)));
                    gainNode8D.gain.value = distGain;

                    pannerInterval = requestAnimationFrame(start8D);
                };
                start8D();
            } else {
                pannerNode.pan.value = 0;
                filterNode.frequency.value = 20000;
                gainNode8D.gain.value = 1.0;
            }
        }
        
        window.cycleEqMode = cycleEqMode;

        let pressTimer;
        const profileTrigger = document.getElementById('profile-trigger');
        profileTrigger.addEventListener('touchstart', () => { pressTimer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); openEditProfile(); }, 3000); });
        profileTrigger.addEventListener('touchend', () => clearTimeout(pressTimer));
        profileTrigger.addEventListener('mousedown', () => { pressTimer = setTimeout(() => openEditProfile(), 3000); });
        profileTrigger.addEventListener('mouseup', () => clearTimeout(pressTimer));

        function openEditProfile() {
            document.getElementById('user-name-input').value = userProfile.name;
            document.getElementById('preview-img').src = userProfile.image;
            document.getElementById('setup-btn').innerText = "Update Profile";
            document.getElementById('setup-screen').style.display = 'flex';
        }

        function openCropper(event) {
            const file = event.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    cropImageEl.src = e.target.result;
                    cropModal.style.display = 'flex';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(cropImageEl, { aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 1 });
                }
                reader.readAsDataURL(file);
            }
        }

        function cancelCrop() {
            cropModal.style.display = 'none';
            document.getElementById('profile-upload').value = '';
            if(cropper) cropper.destroy();
        }

        function saveCrop() {
            if(cropper) {
                const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
                document.getElementById('preview-img').src = canvas.toDataURL();
                cancelCrop();
            }
        }

        function saveProfile() {
            const name = document.getElementById('user-name-input').value;
            const img = document.getElementById('preview-img').src;
            if(!name) { alert("Please enter a name"); return; }
            userProfile = { name: name, image: img };
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            document.getElementById('setup-screen').style.display = 'none';
            loadProfileUI();
        }

        function skipProfile() {
            if(!userProfile) { userProfile = { name: "Guest User", image: DEFAULT_IMG }; localStorage.setItem('userProfile', JSON.stringify(userProfile)); }
            document.getElementById('setup-screen').style.display = 'none';
            loadProfileUI();
        }

        function loadProfileUI() {
            if(userProfile) {
                document.getElementById('display-name').innerText = userProfile.name;
                document.getElementById('header-profile-img').src = userProfile.image;
            }
        }

        async function fetchData() {
            if(!navigator.onLine) { renderHome(); return; }
            if(onlinePlaylists.length === 0) loader.style.display = 'block';
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch('https://ayush8481-dev.github.io/Detabase/?t=' + Date.now(), { signal: controller.signal });
                clearTimeout(timeoutId);
                if(!response.ok) throw new Error("Network error");
                const text = await response.text();
                parseDatabase(text);
            } catch (error) { }
            loader.style.display = 'none';
            renderHome();
        }

        function parseDatabase(text) {
            const lines = text.split('\n');
            let currentPlaylist = null;
            onlinePlaylists = []; 
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                if (line.includes('Playlist Name - "')) {
                    const nameMatch = line.match(/Playlist Name - "([^"]+)"/);
                    if (nameMatch) { currentPlaylist = { name: nameMatch[1], banner: '', songs: [] }; onlinePlaylists.push(currentPlaylist); }
                }
                else if (line.includes('Playlist Banner -')) {
                    const bannerMatch = line.match(/Playlist Banner -"([^"]+)"/);
                    if (bannerMatch && currentPlaylist) currentPlaylist.banner = bannerMatch[1];
                }
                else if (line.match(/^\d+-"/)) {
                    const songMatch = line.match(/^\d+-"([^"]+)"-"([^"]+)"/);
                    if (songMatch && currentPlaylist) {
                        const url = songMatch[1];
                        const img = songMatch[2];
                        let title = "Unknown Track";
                        try {
                            const filename = url.split('/').pop().split('?')[0];
                            title = decodeURIComponent(filename).replace(/\.mp3$/i, '').replace(/%20/g, ' ');
                        } catch (e) {}
                        currentPlaylist.songs.push({ title, url, image: img, artist: "Ayush@8481" });
                    }
                }
            });
        }

        function mergePlaylists() {
            const favPlaylist = { name: "Favorites â¤ï¸", banner: ASSETS[2], songs: likedSongs, isSpecial: true };
            const dlPlaylist = { name: "Downloads ð„ž", banner: ASSETS[3], songs: downloadedSongs, isSpecial: true, isDownloads: true };
            allPlaylists = [...onlinePlaylists, favPlaylist, dlPlaylist];
        }

        function renderHome() {
            mergePlaylists();
            libraryGrid.innerHTML = '';
            const isOfflineMode = (onlinePlaylists.length === 0);
            displayPlaylists = isOfflineMode ? allPlaylists.filter(p => p.isDownloads) : allPlaylists;
            if(displayPlaylists.length === 0) { libraryGrid.innerHTML = '<div style="grid-column: span 2; text-align:center; padding:20px; color:#666;">No Offline Content Available</div>'; return; }
            const cardImages = [];
            displayPlaylists.forEach((pl) => {
                const originalIndex = allPlaylists.indexOf(pl);
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.onclick = () => openPlaylist(originalIndex);
                const bannerSrc = pl.banner || 'https://via.placeholder.com/150';
                card.innerHTML = `<img data-src="${bannerSrc}" class="pc-img"><div class="pc-title">${pl.name}</div><div class="pc-desc">${pl.songs.length} Songs</div>`;
                libraryGrid.appendChild(card);
                cardImages.push(card.querySelector('.pc-img'));
            });
            loadImagesSequentially(cardImages);
        }

        function openPlaylist(index) {
            viewingPlaylistIndex = index;
            const pl = allPlaylists[index];
            checkMarquee(document.getElementById('ph-title'), pl.name);
            document.getElementById('ph-bg').style.backgroundImage = `url('${pl.banner || 'https://via.placeholder.com/300'}')`;
            document.getElementById('ph-count').innerText = `${pl.songs.length} Songs`;
            const listContainer = document.getElementById('playlist-songs');
            listContainer.innerHTML = '';
            if(pl.songs.length === 0) listContainer.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">No songs here yet.</div>';
            const rowImages = [];
            pl.songs.forEach((song, sIndex) => {
                const isDownloaded = downloadedSongs.some(d => d.url === song.url);
                const isPlayingThis = (song.url === player.originalUrl);
                const row = document.createElement('div');
                row.className = `song-row ${isPlayingThis ? 'playing' : ''}`;
                row.onclick = () => playSong(index, sIndex);
                const titleId = `title-${index}-${sIndex}`;
                row.innerHTML = `<img data-src="${song.image}" class="sr-img"><div class="sr-info"><div class="marquee-container" style="width:100%"><div class="sr-title" id="${titleId}">${song.title}</div></div><div class="sr-artist">Ayush@8481</div></div>${isDownloaded ? '<i class="fas fa-check-circle" style="color:var(--accent); font-size:14px;"></i>' : ''}`;
                listContainer.appendChild(row);
                rowImages.push(row.querySelector('.sr-img'));
                setTimeout(() => { checkMarquee(document.getElementById(titleId), song.title); }, 50);
            });
            loadImagesSequentially(rowImages);
            viewHome.classList.remove('active');
            viewPlaylist.classList.add('active');
            window.scrollTo(0,0);
        }

        function checkMarquee(element, text) {
            element.innerText = text; element.classList.remove('scroll');
            requestAnimationFrame(() => { if (element.scrollWidth > element.parentElement.offsetWidth) element.classList.add('scroll'); });
        }

        async function playSong(plIndex, sIndex) {
            if(!audioCtx) initAudioContext();
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            
            player.queue = [...allPlaylists[plIndex].songs];
            player.songIndex = sIndex;
            
            imgContainer.innerHTML = ''; 
            const img = document.createElement('img');
            img.src = player.queue[sIndex].image;
            img.className = 'fp-img active';
            imgContainer.appendChild(img);
            localStorage.setItem('m8_player_closed', 'false');
            loadAndPlay();
        }

        async function loadAndPlay(usePreloaded = false) {
            playSessionId++;
            const currentSession = playSessionId;
            const song = player.queue[player.songIndex];
            player.originalUrl = song.url;
            
            if(cacheTimer) clearTimeout(cacheTimer);
            isNextPreloaded = false; // Reset preload flag for new song

            player.isPlaying = false;
            document.getElementById('mp-img').classList.remove('spin-anim');

            updateMediaSession(song);
            updatePlayerUI();
            
            if(!fullPlayer.classList.contains('active')) {
                document.getElementById('mini-player').classList.add('show');
                document.getElementById('mini-player').style.display = 'flex'; 
            } else {
                document.getElementById('mini-player').style.display = 'none';
            }

            saveSession(); 
            updateCacheMeta(song.url); 
            
            const offlineBlob = await getBlob(song.url);
            if (offlineBlob) { 
                if(currentSession === playSessionId) {
                    audio.src = URL.createObjectURL(offlineBlob);
                    audio.play().then(() => {
                        player.isPlaying = true; updateMediaSession(); updatePlayerUI(); saveSession();
                    }).catch(console.error);
                }
            } 
            else {
                if(currentSession === playSessionId) {
                    audio.src = song.url;
                    audio.play().catch(e => { if(!navigator.onLine) showToast("Network Error", "error"); });
                    
                    fetch(song.url, {priority: 'high'}).then(res => res.blob()).then(blob => {
                        if(currentSession === playSessionId) saveBlob(song.url, blob);
                    }).catch(()=>{});
                }
            }
            audio.title = song.title;
        }

        async function preloadNextSong() {
            if(player.queue.length <= 1) return;
            let nextIndex;
            if (isShuffle) nextIndex = Math.floor(Math.random() * player.queue.length);
            else nextIndex = (player.songIndex + 1) % player.queue.length;
            
            const nextSong = player.queue[nextIndex];
            
            const exists = await getBlob(nextSong.url);
            if(!exists && navigator.onLine) {
                fetch(nextSong.url, {priority: 'low'}).then(res => res.blob()).then(blob => {
                    saveBlob(nextSong.url, blob);
                    updateCacheMeta(nextSong.url);
                }).catch(()=>{});
            }
        }

        function updateMediaSession(forcedSong = null) {
            if (!('mediaSession' in navigator)) return;
            const song = forcedSong || player.queue[player.songIndex];
            if(!song) return;
            navigator.mediaSession.metadata = new MediaMetadata({
                title: song.title, artist: "Ayush@8481", album: "Music@8481",
                artwork: [{ src: song.image, sizes: '512x512', type: 'image/jpeg' }]
            });
            navigator.mediaSession.playbackState = player.isPlaying ? "playing" : "paused";
            navigator.mediaSession.setActionHandler('play', () => audio.play());
            navigator.mediaSession.setActionHandler('pause', () => audio.pause());
            navigator.mediaSession.setActionHandler('nexttrack', () => nextSong(true));
            navigator.mediaSession.setActionHandler('previoustrack', () => prevSong(true));
        }

        audio.addEventListener('play', () => { player.isPlaying = true; updateMediaSession(); updatePlayerUI(); saveSession(); });
        audio.addEventListener('waiting', () => { document.getElementById('mp-img').classList.remove('spin-anim'); }); 
        
        audio.addEventListener('playing', () => { 
            document.getElementById('mp-img').classList.add('spin-anim'); 
            document.getElementById('seek-slider').classList.add('animating'); 
        });
        
        audio.addEventListener('pause', () => { 
            player.isPlaying = false; 
            updateMediaSession(); 
            updatePlayerUI(); 
            saveSession(); 
            document.getElementById('mp-img').classList.remove('spin-anim'); 
            document.getElementById('seek-slider').classList.remove('animating'); 
        });
        audio.addEventListener('ended', () => { if(isLoop) { audio.currentTime = 0; audio.play(); } else nextSong(true); });
        
        audio.addEventListener('timeupdate', () => { 
            const curr = audio.currentTime; 
            const duration = audio.duration || 1;
            
            if(!isNaN(curr)) { 
                seekSlider.value = curr; 
                const percentage = (curr / seekSlider.max) * 100; 
                seekSlider.style.backgroundSize = `${percentage}% 100%, ${percentage}% 100%`;
                document.getElementById('curr-time').innerText = formatTime(curr);
                document.getElementById('mp-progress').style.width = `${(curr / duration) * 100}%`;
                
                if (!isNextPreloaded && (curr / duration) > 0.20) {
                    isNextPreloaded = true;
                    preloadNextSong();
                }

                if ('mediaSession' in navigator && !isNaN(audio.duration)) {
                    navigator.mediaSession.setPositionState({
                        duration: audio.duration,
                        playbackRate: audio.playbackRate,
                        position: audio.currentTime
                    });
                }
                if(Math.floor(curr) % 5 === 0) saveSession();
            } 
        });
        audio.addEventListener('durationchange', () => { if(isFinite(audio.duration)) { document.getElementById('dur-time').innerText = formatTime(audio.duration); seekSlider.max = audio.duration; } });

        function togglePlay() { 
            if(!audioCtx) initAudioContext();
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            if(audio.paused) audio.play(); else audio.pause(); 
        }
        
        function nextSong(animate = false) {
            if (isShuffle) player.songIndex = Math.floor(Math.random() * player.queue.length);
            else player.songIndex = (player.songIndex + 1) % player.queue.length;
            if(animate) animateSlide('next', player.queue[player.songIndex]);
            else document.getElementById('fp-img-area').innerHTML = `<img src="${player.queue[player.songIndex].image}" class="fp-img active">`;
            loadAndPlay(true);
        }
        function prevSong(animate = false) {
            player.songIndex = (player.songIndex - 1 + player.queue.length) % player.queue.length;
            if(animate) animateSlide('prev', player.queue[player.songIndex]);
            else document.getElementById('fp-img-area').innerHTML = `<img src="${player.queue[player.songIndex].image}" class="fp-img active">`;
            loadAndPlay();
        }
        
        function toggleShuffle() { isShuffle = !isShuffle; document.getElementById('btn-shuffle').classList.toggle('active-ctrl', isShuffle); showToast(isShuffle ? "Shuffle On" : "Shuffle Off"); }
        function toggleLoop() { isLoop = !isLoop; document.getElementById('btn-loop').classList.toggle('active-ctrl', isLoop); showToast(isLoop ? "Loop On" : "Loop Off"); }
        seekSlider.addEventListener('input', () => { audio.currentTime = seekSlider.value; });

        async function downloadCurrentSong() {
            const song = player.queue[player.songIndex];
            document.getElementById('options-menu').style.display = 'none';
            if (downloadedSongs.some(d => d.url === song.url)) { showToast("Already Downloaded"); return; }
            showToast("Downloading...");
            try {
                const existing = await getBlob(song.url);
                if(!existing) { const response = await fetch(song.url); const blob = await response.blob(); await saveBlob(song.url, blob); }
                downloadedSongs.push(song); 
                localStorage.setItem('my_downloaded_songs', JSON.stringify(downloadedSongs));
                showToast("Downloaded!", "success");
                updatePlayerUI(); 
                mergePlaylists(); 
            } catch (e) { showToast("Download Failed.", "error"); }
        }

        async function deleteCurrentDownload() {
            const song = player.queue[player.songIndex];
            document.getElementById('options-menu').style.display = 'none';
            downloadedSongs = downloadedSongs.filter(s => s.url !== song.url);
            localStorage.setItem('my_downloaded_songs', JSON.stringify(downloadedSongs));
            await deleteBlob(song.url);
            delete cacheMeta[song.url];
            localStorage.setItem('m8_cache_meta', JSON.stringify(cacheMeta));
            showToast("Deleted from Device");
            updatePlayerUI(); 
            mergePlaylists();
        }

        function openOptionsMenu() { 
            const song = player.queue[player.songIndex];
            const isDownloaded = downloadedSongs.some(d => d.url === song.url);
            document.getElementById('download-option').style.display = isDownloaded ? 'none' : 'flex';
            document.getElementById('delete-option').style.display = isDownloaded ? 'flex' : 'none';
            document.getElementById('options-menu').style.display = 'flex'; 
        }
        function closeOptionsMenu(e) { if(e.target.id === 'options-menu') document.getElementById('options-menu').style.display = 'none'; }

        function updatePlayerUI() {
            const song = player.queue[player.songIndex];
            if(!song) return;
            const iconClass = player.isPlaying ? 'fa-pause' : 'fa-play';
            document.getElementById('mp-play-icon').className = `fas ${iconClass}`;
            document.getElementById('fp-play-icon').className = `fas ${iconClass}`;
            checkMarquee(document.getElementById('mp-title'), song.title);
            checkMarquee(document.getElementById('fp-title'), song.title);
            const miniImg = document.getElementById('mp-img');
            miniImg.src = song.image;
            const isLiked = likedSongs.some(s => s.url === song.url);
            const heartIcon = document.getElementById('fp-heart');
            const mpHeart = document.getElementById('mp-heart');
            if(isLiked) { heartIcon.classList.add('fas', 'liked'); heartIcon.classList.remove('far'); mpHeart.classList.add('fas', 'liked'); mpHeart.classList.remove('far'); } 
            else { heartIcon.classList.remove('fas', 'liked'); heartIcon.classList.add('far'); mpHeart.classList.remove('fas', 'liked'); mpHeart.classList.add('far'); }
            const isDownloaded = downloadedSongs.some(d => d.url === song.url);
            document.getElementById('offline-badge').style.display = isDownloaded ? 'block' : 'none';
            document.title = player.isPlaying ? `${song.title} - Music@8481` : 'Music@8481';
        }

        function formatTime(s) { const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec < 10 ? '0'+sec : sec}`; }
        function toggleLike() {
            const song = player.queue[player.songIndex];
            const existsIndex = likedSongs.findIndex(s => s.url === song.url);
            if(existsIndex > -1) { likedSongs.splice(existsIndex, 1); showToast("Removed from Favorites"); }
            else { likedSongs.push(song); showToast("Added to Favorites"); }
            localStorage.setItem('my_liked_songs', JSON.stringify(likedSongs)); 
            mergePlaylists();
            updatePlayerUI(); 
        }

        function openFullPlayer() { 
            fullPlayer.classList.add('active'); 
            document.getElementById('mini-player').style.display = 'none';
            window.history.pushState({page: 'home'}, document.title, window.location.href);
        }
        
        function showToast(msg, type = 'normal') { 
            const t = document.getElementById('toast'); 
            t.innerText = msg; 
            t.style.background = 'rgba(255,255,255,0.9)'; t.style.color = 'black';
            if(type === 'error') { t.style.background = '#e91429'; t.style.color = 'white'; } 
            else if (type === 'success') { t.style.background = '#1ed760'; t.style.color = 'black'; }
            t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); 
        }
    </script>
</body>
    </html>
